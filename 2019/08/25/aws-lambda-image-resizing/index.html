
<!DOCTYPE html>
<html lang="en,default">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Devhaks 개발 저장소">
    <title>[AWS] CloudFront Lambda@edge 를 이용한 이미지 리사이징 - Devhaks 개발 저장소</title>
    <meta name="author" content="이종학">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"이종학","sameAs":["https://github.com/devhaks/"],"image":"https://www.gravatar.com/avatar/dfca80a65a05d05bf0d417a6ca99a57d"},"articleBody":"이번 글에서는 S3 에 있는 이미지를 Lambda@edge 를 통하여 리사이징 하고 새로운 이미지를 CloudFront 를 통하여 Caching 해보도록 하겠습니다.\n목차\n배경\n\nCloudFront &amp; Lambda@edge\n\nLambda@edge 기본 동작 원리\n\n이미지 리사이징 구현\n\n1) 서비스 요소\n2) S3 버킷 생성\n3) CloudFront 생성\n4) IAM 역할 생성\n5) Lambda 함수 생성\n6) Cloud9 을 이용한 Lambda 함수 작성\n7) Lambda@edge 함수에 Lambda 함수 배포\n8) 이미지 리사이징 실행하기\n9) production 에 배포하기\n\n\nCloudFront 와 CORS(Cross-Origin Resource Sharing)\n\n마치며\n\n참고글\n\n연관글\n\n\n배경서비스를 운영할 때, 대부분 이미지는 배경, 배너 또는 썸네일로 사용합니다. 이미지를 여러가지 용도로 사용하려면 각 사이즈 별로 이미지 파일을 갖고 있어야 합니다. 그리고 예를들어 쇼핑몰에서 사용자에게 더 좋은 인상을 주기위해 고화질 이미지를 사용합니다. \n그러나 문제는 사이즈 종류가 다양해질수록 용량이 기하급수적으로 증가할 것이고 이미지를 관리하기가 쉽지 않습니다. 또한 고화질 이미지는 용량이 크면 이미지 loading 시간이 늘어나서 사용자가 답답함을 느끼게되는 좋지 않은 영향을 끼칩니다. 그렇기 때문에 적절한 이미지를 사용해야 합니다.\n서버 관리자 입장에서는 이미지 생성과 삭제가 빈번할 수록, 이미지 작업을 처리하는 리소스(cpu, memory, storage) 비용도 증가합니다. 서비스에 1만개의 새로운 사이즈의 이미지가 필요하면 그만큼 storage 가 필요할텐데, 이미지당 100kb 라 가정했을 때, 1GB 가 필요합니다. 1GB 저장공간을 국내 호스팅에서 빌린다면, 금전적 비용이 들기 때문에 부담이 큽니다. \n이러한 일반적인 방법으로는 지속적으로 서비스를 운영함에 있어서 어느 순간에 서비스가 급성장하면 어떻게 손을 써야 할지 막막해 질 것입니다. \n그래서 이제 소개할 내용은 이러한 문제점을 해결 할 수 있는 방법입니다. 미리 말씀드리면 내용은 복잡하지만, 이해하면 관리하는 측에서 굉장히 편리하고 성능과 비용을 모두 얻어갈 수 있을거라고 생각합니다.\n\nCloudFront &amp; Lambda@edgeLambda 함수를 복제하여 Clounfront 각 edge location 에 전역 배포\n\n이해를 돕기 위한 큰 흐름 부터 설명합니다. 지도에 표시된 요소는 총 3가지 입니다.\n\nLambda (N Vriginia 리전) - 버지니아 리전에 생성한 Lambda 함수\n\nlocation (λ표시) - CloudFront의 지역 단위인 edge location, 버지니아 Lambda 함수를 복제하여 각 edge location 에 배포한 상태\n\nuser - CloudFront edge location 에 요청하는 클라이언트\n\n\n위의 요소들을 이해 하셨다면, Lambda@edge 라고 불리는 이유를 쉽게 알 수 있습니다.버지니아 Lambda 함수를 복제하여 CloudFront 의 각 edge location 에 전역으로 배포함을 의미합니다. 클라이언트는 어떤 리전에서 요청하던지간에 edge location 에 배포된 Lambda@edge 함수를 거쳐서 응답받게 됩니다.\n\nLambda@edge 기본 동작 원리Image Source: Amazon Lambda Edge Documentation\n\n\nLambda@Edge는 Cloudfront Edge 전후 위치에서 실행되는 Lambda 서비스 입니다.\n\n기본 요소\n\nEnd user: 리소스 요청자\n\nCloudFront Cache: 요청 받은 리소스의 캐싱 여부 판단\n\nOrigin server: CloudFront 에서 지정한 리소스의 origin\n\nex) 리소스가 S3 에 있는 경우, origin 주소: {Bucket}.s3.amazonaws.com\n\n\n\n\nLambda@edge 함수를 trigger 할 4개의 CloudFront 이벤트를 선택 할 수 있습니다.\n\nViewer request: End user 가 CloudFront 로 보내는 요청\n\nOrigin request: CloudFront 에서 cache miss가 일어나면 origin에 리소스 요청\n\nOrigin response: Origin 으로 부터 리소스를 CloudFront 에 응답\n\nViewer response: origin 의 리소스 or cache hit된 응답\n\n\n\n\n예를 들어 이미지를 요청(Viewer request)한다고 가정합시다. CloudFront 에서는 요청 이미지 주소로 캐싱된 이미지의 여부를 판단합니다. 캐싱된 이미지가 있다면 cache hit 로 판단하여 바로 응답(Viewer response) 합니다. \n그러나 캐싱된 이미지가 없다면 cache miss 로 판단하여 Origin server 로 리소스를 요청(Origin request) 합니다. Origin 은 이미지 존재 여부를 판단하여 CloudFront 로 응답(Origin response) 합니다. 리소스가 존재한다면 End User 는 이미지를 응답(200) 받고, 그렇지 않다면 Not Found 응답(404) 받을 것입니다. \n\n이미지 리사이징 구현이제부터 이미지 리사이징 구현을 위한 설명입니다.\n1) 서비스 요소이미지 리사이징을 하기위한 AWS 서비스 요소\n\n필수 요소\n\nCloudFront - 이미지 캐싱 및 Lambda 함수를 배포할 edge location\n\nLambda - 이미지 리사이징을 위한 함수\n\nS3 - 리사이징할 이미지가 저장된 storage\n\nIAM(Identity and Access Management) - 위 이미지에는 없지만, Lambda 함수가 각 요소를 실행하기 위한 역할을 생성하는데 필요합니다.\n\n\n부가 요소\n\nCloudWatchLog - Lambda 함수 실행시, 디버깅 하기 위한 로그 출력 용도 \n\nAWS Cloud9 - Lambda 함수를 작성하기 위한 브라우저 code editor, Lambda 함수를 .zip 파일로 매번 업로드해야하는 불편함을 없애기 위해 사용\n\n\n2) S3 버킷 생성\nS3 콘솔에 접속한 후, 버킷을 생성합니다.\nS3 버킷 생성\n\n\n버킷 이름은 devhaks-sample-s3로 생성했습니다.\n리전은 서울을 선택했습니다.\n\n\n다음과 같은 구조로 객체를 생성 합니다. (S3 에서 디렉토리, 파일을 객체라 부릅니다.)— devhaks-sample-s3&nbsp;&nbsp;&nbsp;|— thumbnail.png&nbsp;&nbsp;&nbsp;|— dev/thumbnail.png&nbsp;&nbsp;&nbsp;|— prod/thumbnail.png\n\n테스트 이미지 다운로드 =&gt; thumbnail.png\ndev, prod 객체를 구분한 이유는 개발과 배포 환경을 구분하여 배포 전에 테스트를 자유롭게 할 수 있도록 설정하기 위함입니다.\n\n\n\n3) CloudFront 생성\nCloudFront 콘솔에 접속합니다.\n\nCreate Distribution 클릭 -&gt; Web 의 Get started 클릭\n\n옵션 설정하기\n1. Origin setting\n\n\nOrigin Domain Name: 생성한 버킷 이름으로 선택\nRestrict Bucket Access: 버킷의 접근 제한을 활성화\nOrigin Access Identity: S3의 접근 권한을 얻기 위한 새로운 Identity 생성\nGrant Read Permissions on Bucket: 선택한 S3 의 버킷 정책에 읽기 권한을 자동으로 생성합니다. (아래 이미지 참고)\n\nCloudFront 에 의해 자동 설정된 S3 버킷 정책\n\n\n\n2. Default Cache Behavior Settings\n\n3. Distribution Settings\n\n\n\n\n\nCloudFront cache behavior 추가\nBehavior 추가하기\n\n\n추가할 때, default behavior 설정과 동일하면서 path pattern 은 다른 behavior 아래 이미지 처럼 추가합니다.\n\n개발용, 배포용 behavior 추가 및 우선순위 설정\n\n\ndev, prod 우선순위 상관 없이 default behavior 보다 우선순위를 높게 설정합니다.\n숫자가 낮을수록 우선순위가 높습니다.\n\n\nCloudFront 적용 여부 확인하기\nCloudFront Dashboard\n\n\n대시보드에서 CloudFront Domain Name 을 복붙하여 아래 경로로 이미지를 요청합니다.\nhttps://{Domain Name}/dev/thumbnail.png\nhttps://{Domain Name}/prod/thumbnail.png\n\nCloudFront 는 글로벌 리전만 존재합니다.CloudFront 생성 후, 적용되는 약 10분 정도 소요됩니다.\n\n\n\n\n4) IAM 역할 생성\nLambda 함수가 여러 서비스에 접근 가능한 역할을 정책을 조합하여 생성합니다.\n\n\n역할 콘솔에 접속하여 ‘역할 만들기’ 버튼을 클릭 후, 아래 이미지를 따릅니다.\n역할 생성 1 단계\n\n다음 페이지에서 ‘정책 생성’ 버튼을 클릭 후, 아래 정책을 JSON 형식에 복붙합니다. 그리고 ‘정책 검토’ 버튼을 클릭 합니다.\n123456789101112131415161718192021&#123;  \"Version\": \"2012-10-17\",  \"Statement\": [      &#123;          \"Sid\": \"VisualEditor0\",          \"Effect\": \"Allow\",          \"Action\": [              \"iam:CreateServiceLinkedRole\",              \"lambda:GetFunction\",              \"lambda:EnableReplication\",              \"cloudfront:UpdateDistribution\",              \"s3:GetObject\",              \"logs:CreateLogGroup\",              \"logs:CreateLogStream\",              \"logs:PutLogEvents\",              \"logs:DescribeLogStreams\"          ],          \"Resource\": \"*\"        &#125;    ]&#125;\n\n정책 생성 2단계\n\n\n정책 이름은 resize_policy를 기입합니다.\n\n\n정책 생성을 완료한 뒤, 역할 생성 2단계에서 resize_policy 정책을 연결합니다. 3단계는 건너뛰고 4단계에서 역할 이름을 ResizeImage로 기입합니다.\n역할 생성 2단계\n\n역할 생성 4단계\n\nResizeImage 역할에 신뢰 관계 추가\nResizeImage 신뢰 관계 편집\n\n\n신뢰 관계 편집 “Service” 부분에 “edgelambda.amazonaws.com” 를 추가합니다.123456789101112131415&#123;  \"Version\": \"2012-10-17\",  \"Statement\": [    &#123;      \"Effect\": \"Allow\",      \"Principal\": &#123;        \"Service\": [          \"edgelambda.amazonaws.com\",          \"lambda.amazonaws.com\"        ]      &#125;,      \"Action\": \"sts:AssumeRole\"    &#125;  ]&#125;\n\n\n\n\n\n5) Lambda 함수 생성\nLambda 함수 콘솔에 접속합니다.\n\n버지니아 리전을 선택 후, ‘Create function’ 클릭\n\n기본 정보 설정\n\n함수 이름: ResizeImage\nRuntime: Node.js 10.x\n권한\n실행 역할: 기존 역할 사용\n기존 역할: ResizeImage - 4) IAM 역할 생성\n\n\n\n\n다음 페이지의 기본 설정 후, ‘Save’ 클릭\n\n메모리: 함수를 실행하는 환경의 메모리 용량을 128MB로 설정\n제한 시간: 함수의 실행 제한 시간을 5초로 설정\n\nLambda@edge 에 배포 하려면 반드시 버지니아 리전에 생성해야 합니다. \n\n\nLambda@edge 요금 페이지에 요금 계산기가 있습니다.\n\n\nLambda vs Lambda@edge\n\n\n\nlanguage: Lambda 와 다르게 Node.js 만 지원함.\nMemory: Lambda@edge 메모리 수정 불가하며 128M 고정. 함수 최적화 필수.\nExecution time: Lambda@edge 기본 동작 원리에 request, response 간에 시간도 소요되므로 최소 4초 이상 걸림.\nDeployment size: 함수의 라이브러리 포함하여 압축 용량이 극히 1MB 로 제한적\nRequest pricing: 100만건당 기준 비용\nDuration granularity: 비용 측정하는 시간 단위\n128MB for 100ms: Lambda@edge 가 50ms 실행 했을 때, 비용은 $0.0000003125 입니다.\n\n6) Cloud9 을 이용한 Lambda 함수 작성\nAWS Cloud9은 코드 작성, 실행 및 디버깅을 위한 클라우드 기반 IDE입니다.\n글쓰는 시점의 Cloud9 은 서울 리전을 지원하지 않습니다.\n\n\nCloud9 요금\n\n\n\n\nCloud9 콘솔에 접속하고 우측의 ‘Create environment’ 클릭\n\n다음 이미지의 설정을 따릅니다.\ncloud9 생성 1단계\n\ncloud9 생성 2단계\n\nResizeImage Lambda 함수를 Cloud9 으로 가져 옵니다. (이미지 번호 순서 확인)\n\n\n패키지 설치\n\n이미지 리사이징 Sharp 패키지를 설치 합니다.12345ec2-user:~/environment $ cd ResizeImageec2-user:~/environment/ResizeImage $ npm init -y...ec2-user:~/environment/ResizeImage $ npm install sharp...\n\n\n\n함수 작성\n\nGist 에 있는 코드를 코드 작성 영역에 복붙하고 Code Line 14 BUCKET 을 수정합니다.\n1const BUCKET = 'devhaks-sample-s3' // Input your bucket\n\n코드 설명\n\n다음과 같이 QueryString 으로 이미지 리사이징 할 정보를 추가하여 요청합니다. \n\nhttps://dilgv5hokpawv.cloudfront.net/dev/thumbnail.png?w=200&amp;h=150&amp;f=webp&amp;q=90\n\n\nLambda 함수는 요청 주소를 ObjectKey 와 QueryString 을 파싱합니다.\n123456789101112const &#123; uri &#125; = request;const ObjectKey = decodeURIComponent(uri).substring(1);const params = querystring.parse(request.querystring);const &#123; w, h, q, f &#125; = params/** * Parsing result * - ObjectKey: 'dev/thumbnail.png' * - w: '200' * - h: '150' * - f: 'webp' * - q: '90' */\n\nS3 로 부터 ObjectKey 와 일치하는 이미지 리소스를 가져옵니다.\n12345678910try &#123;  s3Object = await S3.getObject(&#123;    Bucket: BUCKET,    Key: ObjectKey  &#125;).promise();&#125;catch (error) &#123;  ...  return callback(null, response);&#125;\n\n이미지를 리사이징 합니다.\n123456789101112try &#123;  resizedImage = await Sharp(s3Object.Body)    .resize(width, height)    .toFormat(format, &#123;      quality    &#125;)    .toBuffer();&#125;catch (error) &#123;  ...  return callback(null, response);&#125;\n\nResponse 객체의 정보를 수정하고 함수를 종료합니다.\n1234567891011121314151617181920212223242526responseHandler(  200,  'OK',  resizedImage.toString('base64'), [&#123;    key: 'Content-Type',    value: `image/$&#123;format&#125;`  &#125;],  'base64');/** * @summary response 객체 수정을 위한 wrapping 함수*/function responseHandler(status, statusDescription, body, contentHeader, bodyEncoding) &#123;  response.status = status;  response.statusDescription = statusDescription;  response.body = body;  response.headers['content-type'] = contentHeader;  if (bodyEncoding) &#123;    response.bodyEncoding = bodyEncoding;  &#125;&#125;console.log('Success resizing image');return callback(null, response);\n\nLambda 함수 업데이트\n\n\n\n\n\n\n\n\n\n7) Lambda@edge 함수에 Lambda 함수 배포\nLambda 함수 콘솔에 재접속하여 ResizeImage 함수 정보로 이동합니다.\n\n상단 메뉴에 작업 &gt; Lambda@edge 배포를 클릭하고 아래 이미지 처럼 설정을 따릅니다.\n\n\n\n캐시 동작: production 배포 전, 먼저 dev/*에서 테스트를 진행 합니다.\n\nCloudFront 이벤트: 오리진 응답(Origin response)을 선택합니다. 왜냐하면 origin 에서 리소스 존재 여부를 판단 후 존재하면, 함수를 실행시켜야 하기 때문입니다.\n\n배포 완료된 상태\n\n\n\n\nLambda@edge 함수에 배포 후, 적용까지 약 3~5분 정도 소요됩니다.\n\n\n\n\n8) 이미지 리사이징 요청하기\n요청할 이미지 주소: https://dilgv5hokpawv.cloudfront.net/dev/thumbnail.png?w=200&amp;h=150&amp;f=webp&amp;q=90\n\n리사이징된 이미지 결과 확인\n\n결과를 확인하면 이미지의 800x800 -&gt; 200x150 으로 변경된 이미지를 확인 할 수 있습니다.\n\n개발자 도구를 열어서 이미지 리소스의 response header 를 확인\n\ncontent-type: image/webp\n최초 이미지 요청시  x-cache: Miss from cloudfront\n다음 이미지 요청시,  x-cache: Hit from cloudfront\n\n\n\n\nCloudWatch Log 확인\nCloudWatch 콘솔에 접속하여 좌측 ‘로그’ 페이지로 이동합니다. \n  \n\n  \n\n  \n\n위 로그 그룹이 보이지 않는다면, 서울 리전을 확인하세요.   \n\n\n이미지 생성이 안될 경우\n\n이 문제는 Lambda@edge 가 배포 되기 전에 이미 한번 요청한 주소의 리소스가 캐시된 경우 발생합니다. 그래서 캐싱된 리소스를 invalidation(무효화)를 해야합니다./dev/* 경로는 /dev 뒤에 붙는 리소스를 가리킵니다. (/ = root path)\n\n\n\n\nCloudFront caching 방식의 기준은 주소 또는 헤더 설정에 따라 다릅니다. 여기서 주소 방식은 QueryString 순서만 변경되어도 다른 리소스로 인식됩니다.ex 1) ?w=200&amp;h=150&amp;f=webp&amp;q=90ex 2) ?h=150&amp;w=200&amp;f=webp&amp;q=90두 이미지의 결과는 동일 하지만, caching은 1번이 아닌 2번이 발생합니다. 심각한 문제는 아니지만. 이미지 리사이징 할때, 똑같은 결과물이 2번 생성하지 않도록 주의 합시다.\n\n\n\n\n\n9) production 에 배포하기\n7) Lambda@edge 함수에 Lambda 함수 배포 과정의 첫번째 이미지에서 캐시 동작을 dev/* 로 지정 했었습니다. 이미지 리사이징이 성공했다면, 트리거 추가버튼을 클릭하여 캐시 동작을 prod/*로 선택하고 나머지 옵션은 동일하게 하여 추가합니다. 아래 이미지 처럼 2개의 CloudFront 이벤트 트리거가 등록된 것을 확인할 수 있습니다.\n\n\n\n\n\n\nCloudFront 와 CORS(Cross-Origin Resource Sharing)  위 예제에서는 브라우저 주소창에 이미지 주소를 바로 요청했기 때문에 CORS에 제약을 받는 상황은 없었습니다. 왜냐하면, 브라우저 주소가 이미지 주소의 origin 과 동일한 same origin 이기 때문이빈다. \n  브라우저 기본 기능에는 &lt;img/&gt;, &lt;script/&gt;, &lt;link/&gt; 태그를 사용하여 리소스를 얻을 수 있습니다. \n  그러나 XHR (XMLHttpRequest) 로 리소스를 요청 할 경우, CORS 제약을 받아서 리소스를 얻을 수 없습니다. 이러한 경우, 리소스를 보유한 Origin 에서 CORS 정책을 설정하여 해결 해야합니다.  \n\nCORS 제약을 받는 상황을 만들기 위해 S3(Origin)에 다음과 같이 pdf 파일을 업로드합니다.\n— devhaks-sample-s3&nbsp;&nbsp;&nbsp;|— devhaks-github-io.pdf&nbsp;&nbsp;(&lt;= 파일 다운로드)\n\n브라우저 pdf viewer 로 pdf 를 불러오면, 아래 이미지처럼 에러가 발생합니다.\n\n아래 ‘your_cloudfront_domain’ 부분을 주소에 맞게 바꿔주세요.\n\nhttps://mozilla.github.io/pdf.js/web/viewer.html?file=https://your_cloudfront_domain/devhaks-github-io.pdf\n\n\n\n\n\n요청지: https://mozilla.github.io\nOrigin: https://your_cloudfront_domain\npdf viewer 는 pdf 의 주소로 XHR 요청을 보내는데 요청지와 Origin 이 서로 다르기 때문에 위와 같은 에러가 발생한 것입니다.\n\n\n이를 해결하기 위해 S3 콘솔 -&gt; 버킷 -&gt; 권한 -&gt; CORS 구성으로 이동하여 다음을 복붙하고 저장합니다. 그리고 다시 pdf viewer 를 새로고침 해보면, 정상적으로 pdf 파일이 출력 될 것입니다.\n1234567&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;CORSConfiguration xmlns=\"http://s3.amazonaws.com/doc/2006-03-01/\"&gt;&lt;CORSRule&gt;    &lt;AllowedOrigin&gt;https://mozilla.github.io&lt;/AllowedOrigin&gt;    &lt;AllowedMethod&gt;GET&lt;/AllowedMethod&gt;&lt;/CORSRule&gt;&lt;/CORSConfiguration&gt;\n\n\n\n\n마치며이번 글을 정리하면서 익숙하지 않았거나 궁금했던 AWS 서비스의 요소들을 자세히 학습하게되서 뿌듯하고 실력이 향상되는 느낌이 많이 들었습니다. 지금은 개발 중인 서비스에 적용한 것에 그치지만 개인 프로젝트를 진행 할 때, 꼭 적용 해봐야 겠습니다. \n참고글\n당근마켓 블로그 AWS Lambda@Edge에서 실시간 이미지 리사이즈 &amp; WebP 형식으로 변환\n\nheropy tech AWS Lambda@edge로 실시간 이미지 리사이징\n\nAWS Lambda@Edge 함수 예제\n\n\n연관글\nAWS Lambda에서 메모리 설정값과 CPU 파워의 관계\n\n","dateCreated":"2019-08-25T15:49:12+09:00","dateModified":"2019-09-03T20:36:07+09:00","datePublished":"2019-08-25T15:49:12+09:00","description":"이번 글에서는 S3 에 있는 이미지를 Lambda@edge 를 통하여 리사이징 하고 새로운 이미지를 CloudFront 를 통하여 Caching 해보도록 하겠습니다.\n\n목차\n * 배경\n   \n   \n * CloudFront & Lambda@edge\n   \n   \n * Lambda@edge 기본 동작 원리\n   \n   \n * 이미지 리사이징 구현\n   \n    * 1) 서비스 요소\n    * 2) S3 버킷 생성\n    * 3) CloudFront 생성\n    * 4) IAM 역할 생성\n    * 5) Lambda 함수 생성\n    ","headline":"[AWS] CloudFront Lambda@edge 를 이용한 이미지 리사이징","image":["thumbnail.png","cover.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/"},"publisher":{"@type":"Organization","name":"이종학","sameAs":["https://github.com/devhaks/"],"image":"https://www.gravatar.com/avatar/dfca80a65a05d05bf0d417a6ca99a57d","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/dfca80a65a05d05bf0d417a6ca99a57d"}},"url":"https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/","keywords":"aws, image resize, CloudFront, Lambda@edge, cloud9, s3","thumbnailUrl":"thumbnail.png"}</script>
    
    
    
        
    

    
        <meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/thumbnail.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/thumbnail.png" />
    
    
    
        <meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cover.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cover.png" />
    
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/dfca80a65a05d05bf0d417a6ca99a57d?s=640"/>
    
    
    

    <meta name="description" content="이번 글에서는 S3 에 있는 이미지를 Lambda@edge 를 통하여 리사이징 하고 새로운 이미지를 CloudFront 를 통하여 Caching 해보도록 하겠습니다.  목차  * 배경          * CloudFront &amp; Lambda@edge          * Lambda@edge 기본 동작 원리          * 이미지 리사이징 구현">
<meta name="keywords" content="aws,image resize,CloudFront,Lambda@edge,cloud9,s3">
<meta property="og:type" content="blog">
<meta property="og:title" content="[AWS] CloudFront Lambda@edge 를 이용한 이미지 리사이징">
<meta property="og:url" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/index.html">
<meta property="og:site_name" content="Devhaks 개발 저장소">
<meta property="og:description" content="이번 글에서는 S3 에 있는 이미지를 Lambda@edge 를 통하여 리사이징 하고 새로운 이미지를 CloudFront 를 통하여 Caching 해보도록 하겠습니다.  목차  * 배경          * CloudFront &amp; Lambda@edge          * Lambda@edge 기본 동작 원리          * 이미지 리사이징 구현">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/global.jpg">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/workflow1.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/components.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/s3_create.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/CloudFront_setting_1.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/s3_bucket_read.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/CloudFront_setting_2.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/CloudFront_setting_3.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/behavior_1.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/behavior_2.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloudfront_dashboard.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/iam_1.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/iam_2.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/iam_3.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/iam_4.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/iam_5.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/compare_lambda.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloud9_1.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloud9_2.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloud9_code_1.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloud9_code_2.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/lambda_edge_deploy.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/lambda_edge_deploy_2.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloudwatch_1.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloudwatch_2.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloudwatch_3.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/cloudfront_invalidation.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/lambda_edge_deploy_3.png">
<meta property="og:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/pdf_cors.png">
<meta property="og:updated_time" content="2019-09-03T11:36:07.515Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[AWS] CloudFront Lambda@edge 를 이용한 이미지 리사이징">
<meta name="twitter:description" content="이번 글에서는 S3 에 있는 이미지를 Lambda@edge 를 통하여 리사이징 하고 새로운 이미지를 CloudFront 를 통하여 Caching 해보도록 하겠습니다.  목차  * 배경          * CloudFront &amp; Lambda@edge          * Lambda@edge 기본 동작 원리          * 이미지 리사이징 구현">
<meta name="twitter:image" content="https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/global.jpg">


    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-dig2yh02rpgcdxsbsfha8ujj65grwfvm3xbp1gpa6w8uj8k150ymhv97ed5p.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135461398-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-135461398-1');
    </script>


    
</head>

    <body>
        
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Devhaks 개발 저장소</a>
    </div>

    <div class="progress-container">
        <div class="progress-bar" id="myBar"></div>
    </div>
    


    
        
            <a  class="header-right-picture "
                href="/me">
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/dfca80a65a05d05bf0d417a6ca99a57d?s=90" alt="Author&#39;s picture"/>
        
        </a>
    
</header>


<style>
    /* The progress container (grey background) */
    .progress-container {
        width: 100%;
        height: 10px;
        background: #ccc;
        
    }
    /* The progress bar (scroll indicator) */
    .progress-bar {
        height: 10px;
        background: #ff5151;
        width: 0%;
    }
</style>

<script>
    // When the user scrolls the page, execute myFunction 
    window.onscroll = function() {myFunction()};

    function myFunction() {
        var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        var scrolled = (winScroll / height) * 100;
        document.getElementById("myBar").style.width = scrolled + "%";
    }
</script>
            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/dfca80a65a05d05bf0d417a6ca99a57d?s=110" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">이종학</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/me"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/devhaks/" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-left
                    post-header-cover--full"
             style="background-image:url('/2019/08/25/aws-lambda-image-resizing/cover.png');"
             data-behavior="5">
            
                <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            [AWS] CloudFront Lambda@edge 를 이용한 이미지 리사이징
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2019-08-25T15:49:12+09:00">
	
		    Aug 25, 2019
    	
    </time>
    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="5"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    

    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>이번 글에서는 S3 에 있는 이미지를 Lambda@edge 를 통하여 <b>리사이징</b> 하고 새로운 이미지를 CloudFront 를 통하여 <b>Caching</b> 해보도록 하겠습니다.</p>
<h2 id="목차"><a href="#목차" class="headerlink" title="목차"></a>목차</h2><ul>
<li><p><a href="#배경">배경</a></p>
</li>
<li><p><a href="#CloudFront-amp-Lambda-edge">CloudFront &amp; Lambda@edge</a></p>
</li>
<li><p><a href="#Lambda-edge-기본-동작-원리">Lambda@edge 기본 동작 원리</a></p>
</li>
<li><p><a href="#이미지-리사이징-구현">이미지 리사이징 구현</a></p>
<ul>
<li><a href="#1-서비스-요소">1) 서비스 요소</a></li>
<li><a href="#2-S3-버킷-생성">2) S3 버킷 생성</a></li>
<li><a href="#3-CloudFront-생성">3) CloudFront 생성</a></li>
<li><a href="#4-IAM-역할-생성">4) IAM 역할 생성</a></li>
<li><a href="#5-Lambda-함수-생성">5) Lambda 함수 생성</a></li>
<li><a href="#6-Cloud9-을-이용한-Lambda-함수-작성">6) Cloud9 을 이용한 Lambda 함수 작성</a></li>
<li><a href="#7-Lambda-edge-함수에-Lambda-함수-배포">7) Lambda@edge 함수에 Lambda 함수 배포</a></li>
<li><a href="#8-이미지-리사이징-실행하기">8) 이미지 리사이징 실행하기</a></li>
<li><a href="#9-production-에-배포하기">9) production 에 배포하기</a></li>
</ul>
</li>
<li><p><a href="#CloudFront-와-CORS-Cross-Origin-Resource-Sharing">CloudFront 와 CORS(Cross-Origin Resource Sharing)</a></p>
</li>
<li><p><a href="#마치며">마치며</a></p>
</li>
<li><p><a href="#참고글">참고글</a></p>
</li>
<li><p><a href="#연관글">연관글</a></p>
</li>
</ul>
<h2 id="배경"><a href="#배경" class="headerlink" title="배경"></a>배경</h2><p>서비스를 운영할 때, 대부분 이미지는 배경, 배너 또는 썸네일로 사용합니다. 이미지를 여러가지 용도로 사용하려면 각 사이즈 별로 이미지 파일을 갖고 있어야 합니다. 그리고 예를들어 쇼핑몰에서 사용자에게 더 좋은 인상을 주기위해 고화질 이미지를 사용합니다. </p>
<p>그러나 문제는 사이즈 종류가 다양해질수록 용량이 기하급수적으로 증가할 것이고 이미지를 관리하기가 쉽지 않습니다. 또한 고화질 이미지는 용량이 크면 이미지 loading 시간이 늘어나서 사용자가 답답함을 느끼게되는 좋지 않은 영향을 끼칩니다. 그렇기 때문에 적절한 이미지를 사용해야 합니다.</p>
<p>서버 관리자 입장에서는 이미지 생성과 삭제가 빈번할 수록, 이미지 작업을 처리하는 리소스(cpu, memory, storage) 비용도 증가합니다. 서비스에 1만개의 새로운 사이즈의 이미지가 필요하면 그만큼 storage 가 필요할텐데, 이미지당 100kb 라 가정했을 때, 1GB 가 필요합니다. 1GB 저장공간을 국내 호스팅에서 빌린다면, 금전적 비용이 들기 때문에 부담이 큽니다. </p>
<p>이러한 일반적인 방법으로는 지속적으로 서비스를 운영함에 있어서 어느 순간에 서비스가 급성장하면 어떻게 손을 써야 할지 막막해 질 것입니다. </p>
<p>그래서 이제 소개할 내용은 이러한 문제점을 해결 할 수 있는 방법입니다. 미리 말씀드리면 내용은 복잡하지만, 이해하면 관리하는 측에서 굉장히 편리하고 <b>성능과 비용</b>을 모두 얻어갈 수 있을거라고 생각합니다.</p>
<hr>
<h2 id="CloudFront-amp-Lambda-edge"><a href="#CloudFront-amp-Lambda-edge" class="headerlink" title="CloudFront &amp; Lambda@edge"></a>CloudFront &amp; Lambda@edge</h2><div class="figure center" style="width:90%;"><a class="fancybox" href="global.jpg" title="Lambda 함수를 복제하여 Clounfront 각 edge location 에 전역 배포" data-caption="Lambda 함수를 복제하여 Clounfront 각 edge location 에 전역 배포" data-fancybox="default"><img class="fig-img" src="global.jpg" style="width:90%;" alt="Lambda 함수를 복제하여 Clounfront 각 edge location 에 전역 배포"></a><span class="caption">Lambda 함수를 복제하여 Clounfront 각 edge location 에 전역 배포</span></div><div style="clear:both;"></div>

<p>이해를 돕기 위한 큰 흐름 부터 설명합니다. 지도에 표시된 요소는 총 3가지 입니다.</p>
<ol>
<li><p>Lambda (N Vriginia 리전) - 버지니아 리전에 생성한 Lambda 함수</p>
</li>
<li><p>location (λ표시) - CloudFront의 지역 단위인 edge location, 버지니아 Lambda 함수를 복제하여 각 edge location 에 배포한 상태</p>
</li>
<li><p>user - CloudFront edge location 에 요청하는 클라이언트</p>
</li>
</ol>
<p>위의 요소들을 이해 하셨다면, <a href="https://docs.aws.amazon.com/ko_kr/Lambda/latest/dg/Lambda-edge.html" target="_blank" rel="noopener">Lambda@edge</a> 라고 불리는 이유를 쉽게 알 수 있습니다.<br>버지니아 Lambda 함수를 복제하여 CloudFront 의 각 edge location 에 전역으로 배포함을 의미합니다. 클라이언트는 어떤 리전에서 요청하던지간에 edge location 에 배포된 Lambda@edge 함수를 거쳐서 응답받게 됩니다.</p>
<hr>
<h2 id="Lambda-edge-기본-동작-원리"><a href="#Lambda-edge-기본-동작-원리" class="headerlink" title="Lambda@edge 기본 동작 원리"></a>Lambda@edge 기본 동작 원리</h2><div class="figure center" style="width:90%;"><a class="fancybox" href="workflow1.png" title="Image Source: Amazon Lambda Edge Documentation" data-caption="Image Source: Amazon Lambda Edge Documentation" data-fancybox="default"><img class="fig-img" src="workflow1.png" style="width:90%;" alt="Image Source: Amazon Lambda Edge Documentation"></a><span class="caption">Image Source: Amazon Lambda Edge Documentation</span></div><div style="clear:both;"></div>

<ul>
<li><p>Lambda@Edge는 Cloudfront Edge 전후 위치에서 실행되는 Lambda 서비스 입니다.</p>
</li>
<li><p>기본 요소</p>
<ul>
<li><p>End user: 리소스 요청자</p>
</li>
<li><p>CloudFront Cache: 요청 받은 리소스의 캐싱 여부 판단</p>
</li>
<li><p>Origin server: CloudFront 에서 지정한 리소스의 origin</p>
<ul>
<li>ex) 리소스가 S3 에 있는 경우, origin 주소: {Bucket}.s3.amazonaws.com</li>
</ul>
</li>
</ul>
</li>
<li><p>Lambda@edge 함수를 trigger 할 4개의 CloudFront 이벤트를 선택 할 수 있습니다.</p>
<ul>
<li><p>Viewer request: End user 가 CloudFront 로 보내는 요청</p>
</li>
<li><p>Origin request: CloudFront 에서 <code>cache miss</code>가 일어나면 origin에 리소스 요청</p>
</li>
<li><p>Origin response: Origin 으로 부터 리소스를 CloudFront 에 응답</p>
</li>
<li><p>Viewer response: origin 의 리소스 or <code>cache hit</code>된 응답</p>
</li>
</ul>
</li>
</ul>
<p>예를 들어 이미지를 요청(Viewer request)한다고 가정합시다. CloudFront 에서는 요청 이미지 주소로 캐싱된 이미지의 여부를 판단합니다. 캐싱된 이미지가 있다면 <code>cache hit</code> 로 판단하여 바로 응답(Viewer response) 합니다. </p>
<p>그러나 캐싱된 이미지가 없다면 <code>cache miss</code> 로 판단하여 Origin server 로 리소스를 요청(Origin request) 합니다. Origin 은 이미지 존재 여부를 판단하여 CloudFront 로 응답(Origin response) 합니다. 리소스가 존재한다면 End User 는 <code>이미지를 응답(200)</code> 받고, 그렇지 않다면 <code>Not Found 응답(404)</code> 받을 것입니다. </p>
<hr>
<h2 id="이미지-리사이징-구현"><a href="#이미지-리사이징-구현" class="headerlink" title="이미지 리사이징 구현"></a>이미지 리사이징 구현</h2><p>이제부터 이미지 리사이징 구현을 위한 설명입니다.</p>
<h4 id="1-서비스-요소"><a href="#1-서비스-요소" class="headerlink" title="1) 서비스 요소"></a>1) 서비스 요소</h4><div class="figure center" style="width:90%;"><a class="fancybox" href="components.png" title="이미지 리사이징을 하기위한 AWS 서비스 요소" data-caption="이미지 리사이징을 하기위한 AWS 서비스 요소" data-fancybox="default"><img class="fig-img" src="components.png" style="width:90%;" alt="이미지 리사이징을 하기위한 AWS 서비스 요소"></a><span class="caption">이미지 리사이징을 하기위한 AWS 서비스 요소</span></div><div style="clear:both;"></div>

<p>필수 요소</p>
<ol>
<li><p><a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/Introduction.html" target="_blank" rel="noopener">CloudFront</a> - 이미지 캐싱 및 Lambda 함수를 배포할 edge location</p>
</li>
<li><p><a href="https://docs.aws.amazon.com/ko_kr/Lambda/latest/dg/welcome.html" target="_blank" rel="noopener">Lambda</a> - 이미지 리사이징을 위한 함수</p>
</li>
<li><p><a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/dev/Welcome.html" target="_blank" rel="noopener">S3</a> - 리사이징할 이미지가 저장된 storage</p>
</li>
<li><p><a href="https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/introduction.html" target="_blank" rel="noopener">IAM(Identity and Access Management)</a> - 위 이미지에는 없지만, Lambda 함수가 각 요소를 실행하기 위한 <b>역할</b>을 생성하는데 필요합니다.</p>
</li>
</ol>
<p>부가 요소</p>
<ol>
<li><p><a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html" target="_blank" rel="noopener">CloudWatchLog</a> - Lambda 함수 실행시, 디버깅 하기 위한 로그 출력 용도 </p>
</li>
<li><p><a href="https://aws.amazon.com/ko/cloud9/" target="_blank" rel="noopener">AWS Cloud9</a> - Lambda 함수를 작성하기 위한 브라우저 code editor, Lambda 함수를 .zip 파일로 매번 업로드해야하는 불편함을 없애기 위해 사용</p>
</li>
</ol>
<h4 id="2-S3-버킷-생성"><a href="#2-S3-버킷-생성" class="headerlink" title="2) S3 버킷 생성"></a>2) S3 버킷 생성</h4><ol>
<li><p><a href="https://s3.console.aws.amazon.com/s3/" target="_blank" rel="noopener">S3 콘솔</a>에 접속한 후, 버킷을 생성합니다.</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="s3_create.png" title="S3 버킷 생성" data-caption="S3 버킷 생성" data-fancybox="default"><img class="fig-img" src="s3_create.png" style="width:90%;" alt="S3 버킷 생성"></a><span class="caption">S3 버킷 생성</span></div><div style="clear:both;"></div>

<ul>
<li>버킷 이름은 <code>devhaks-sample-s3</code>로 생성했습니다.</li>
<li>리전은 <code>서울</code>을 선택했습니다.</li>
</ul>
</li>
<li><p>다음과 같은 구조로 객체를 생성 합니다. (S3 에서 디렉토리, 파일을 객체라 부릅니다.)<br>— devhaks-sample-s3<br>&nbsp;&nbsp;&nbsp;|— thumbnail.png<br>&nbsp;&nbsp;&nbsp;|— dev/thumbnail.png<br>&nbsp;&nbsp;&nbsp;|— prod/thumbnail.png</p>
<ul>
<li>테스트 이미지 다운로드 =&gt; <a href="./thumbnail.png" target="_blank">thumbnail.png</a></li>
<li>dev, prod 객체를 구분한 이유는 개발과 배포 환경을 구분하여 배포 전에 테스트를 자유롭게 할 수 있도록 설정하기 위함입니다.</li>
</ul>
</li>
</ol>
<h4 id="3-CloudFront-생성"><a href="#3-CloudFront-생성" class="headerlink" title="3) CloudFront 생성"></a>3) CloudFront 생성</h4><ol>
<li><p><a href="https://console.aws.amazon.com/cloudfront/" target="_blank" rel="noopener">CloudFront 콘솔</a>에 접속합니다.</p>
</li>
<li><p><code>Create Distribution</code> 클릭 -&gt; Web 의 <code>Get started</code> 클릭</p>
</li>
<li><p>옵션 설정하기</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="CloudFront_setting_1.png" title="1. Origin setting" data-caption="1. Origin setting" data-fancybox="default"><img class="fig-img" src="CloudFront_setting_1.png" style="width:90%;" alt="1. Origin setting"></a><span class="caption">1. Origin setting</span></div><div style="clear:both;"></div>

<ul>
<li>Origin Domain Name: 생성한 버킷 이름으로 선택</li>
<li>Restrict Bucket Access: 버킷의 접근 제한을 활성화</li>
<li>Origin Access Identity: S3의 접근 권한을 얻기 위한 새로운 Identity 생성</li>
<li>Grant Read Permissions on Bucket: 선택한 S3 의 <code>버킷 정책</code>에 읽기 권한을 자동으로 생성합니다. (아래 이미지 참고)</li>
</ul>
<div class="figure center" style="width:90%;"><a class="fancybox" href="s3_bucket_read.png" title="CloudFront 에 의해 자동 설정된 S3 버킷 정책" data-caption="CloudFront 에 의해 자동 설정된 S3 버킷 정책" data-fancybox="default"><img class="fig-img" src="s3_bucket_read.png" style="width:90%;" alt="CloudFront 에 의해 자동 설정된 S3 버킷 정책"></a><span class="caption">CloudFront 에 의해 자동 설정된 S3 버킷 정책</span></div><div style="clear:both;"></div>

<br>

<div class="figure center" style="width:90%;"><a class="fancybox" href="CloudFront_setting_2.png" title="2. Default Cache Behavior Settings" data-caption="2. Default Cache Behavior Settings" data-fancybox="default"><img class="fig-img" src="CloudFront_setting_2.png" style="width:90%;" alt="2. Default Cache Behavior Settings"></a><span class="caption">2. Default Cache Behavior Settings</span></div><div style="clear:both;"></div>

<div class="figure center" style="width:90%;"><a class="fancybox" href="CloudFront_setting_3.png" title="3. Distribution Settings" data-caption="3. Distribution Settings" data-fancybox="default"><img class="fig-img" src="CloudFront_setting_3.png" style="width:90%;" alt="3. Distribution Settings"></a><span class="caption">3. Distribution Settings</span></div><div style="clear:both;"></div>


</li>
</ol>
<ol start="4">
<li><p>CloudFront cache behavior 추가</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="behavior_1.png" title="Behavior 추가하기" data-caption="Behavior 추가하기" data-fancybox="travel"><img class="fig-img" src="behavior_1.png" style="width:90%;" alt="Behavior 추가하기"></a><span class="caption">Behavior 추가하기</span></div><div style="clear:both;"></div>

<ul>
<li>추가할 때, default behavior 설정과 동일하면서 path pattern 은 다른 behavior 아래 이미지 처럼 추가합니다.</li>
</ul>
<div class="figure center" style="width:90%;"><a class="fancybox" href="behavior_2.png" title="개발용, 배포용 behavior 추가 및 우선순위 설정" data-caption="개발용, 배포용 behavior 추가 및 우선순위 설정" data-fancybox="travel"><img class="fig-img" src="behavior_2.png" style="width:90%;" alt="개발용, 배포용 behavior 추가 및 우선순위 설정"></a><span class="caption">개발용, 배포용 behavior 추가 및 우선순위 설정</span></div><div style="clear:both;"></div>

<ul>
<li>dev, prod 우선순위 상관 없이 default behavior 보다 우선순위를 높게 설정합니다.</li>
<li>숫자가 낮을수록 우선순위가 높습니다.</li>
</ul>
</li>
<li><p>CloudFront 적용 여부 확인하기</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="cloudfront_dashboard.png" title="CloudFront Dashboard" data-caption="CloudFront Dashboard" data-fancybox="default"><img class="fig-img" src="cloudfront_dashboard.png" style="width:90%;" alt="CloudFront Dashboard"></a><span class="caption">CloudFront Dashboard</span></div><div style="clear:both;"></div>

<ul>
<li>대시보드에서 CloudFront <code>Domain Name</code> 을 복붙하여 아래 경로로 이미지를 요청합니다.</li>
<li>https://{Domain Name}/dev/thumbnail.png</li>
<li>https://{Domain Name}/prod/thumbnail.png</li>
</ul>
<div class="alert warning"><p>CloudFront 는 글로벌 리전만 존재합니다.<br>CloudFront 생성 후, 적용되는 약 10분 정도 소요됩니다.</p>
</div>

</li>
</ol>
<h4 id="4-IAM-역할-생성"><a href="#4-IAM-역할-생성" class="headerlink" title="4) IAM 역할 생성"></a>4) IAM 역할 생성</h4><ul>
<li>Lambda 함수가 여러 서비스에 접근 가능한 역할을 <code>정책</code>을 조합하여 생성합니다.</li>
</ul>
<ol>
<li><p><a href="https://console.aws.amazon.com/iam/home#/roles" target="_blank" rel="noopener">역할 콘솔</a>에 접속하여 ‘역할 만들기’ 버튼을 클릭 후, 아래 이미지를 따릅니다.</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="iam_1.png" title="역할 생성 1 단계" data-caption="역할 생성 1 단계" data-fancybox="default"><img class="fig-img" src="iam_1.png" style="width:90%;" alt="역할 생성 1 단계"></a><span class="caption">역할 생성 1 단계</span></div><div style="clear:both;"></div>
</li>
<li><p>다음 페이지에서 ‘정책 생성’ 버튼을 클릭 후, 아래 정책을 JSON 형식에 복붙합니다. 그리고 ‘정책 검토’ 버튼을 클릭 합니다.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="attr">"Sid"</span>: <span class="string">"VisualEditor0"</span>,</span><br><span class="line">          <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">          <span class="attr">"Action"</span>: [</span><br><span class="line">              <span class="string">"iam:CreateServiceLinkedRole"</span>,</span><br><span class="line">              <span class="string">"lambda:GetFunction"</span>,</span><br><span class="line">              <span class="string">"lambda:EnableReplication"</span>,</span><br><span class="line">              <span class="string">"cloudfront:UpdateDistribution"</span>,</span><br><span class="line">              <span class="string">"s3:GetObject"</span>,</span><br><span class="line">              <span class="string">"logs:CreateLogGroup"</span>,</span><br><span class="line">              <span class="string">"logs:CreateLogStream"</span>,</span><br><span class="line">              <span class="string">"logs:PutLogEvents"</span>,</span><br><span class="line">              <span class="string">"logs:DescribeLogStreams"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="figure center" style="width:90%;"><a class="fancybox" href="iam_2.png" title="정책 생성 2단계" data-caption="정책 생성 2단계" data-fancybox="default"><img class="fig-img" src="iam_2.png" style="width:90%;" alt="정책 생성 2단계"></a><span class="caption">정책 생성 2단계</span></div><div style="clear:both;"></div>

<ul>
<li>정책 이름은 <code>resize_policy</code>를 기입합니다.</li>
</ul>
</li>
<li><p>정책 생성을 완료한 뒤, 역할 생성 2단계에서 <code>resize_policy</code> 정책을 연결합니다. 3단계는 건너뛰고 4단계에서 역할 이름을 <code>ResizeImage</code>로 기입합니다.</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="iam_3.png" title="역할 생성 2단계" data-caption="역할 생성 2단계" data-fancybox="default"><img class="fig-img" src="iam_3.png" style="width:90%;" alt="역할 생성 2단계"></a><span class="caption">역할 생성 2단계</span></div><div style="clear:both;"></div>

<div class="figure center" style="width:90%;"><a class="fancybox" href="iam_4.png" title="역할 생성 4단계" data-caption="역할 생성 4단계" data-fancybox="default"><img class="fig-img" src="iam_4.png" style="width:90%;" alt="역할 생성 4단계"></a><span class="caption">역할 생성 4단계</span></div><div style="clear:both;"></div>
</li>
<li><p><code>ResizeImage</code> 역할에 신뢰 관계 추가</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="iam_5.png" title="ResizeImage 신뢰 관계 편집" data-caption="ResizeImage 신뢰 관계 편집" data-fancybox="default"><img class="fig-img" src="iam_5.png" style="width:90%;" alt="ResizeImage 신뢰 관계 편집"></a><span class="caption">ResizeImage 신뢰 관계 편집</span></div><div style="clear:both;"></div>

<ul>
<li>신뢰 관계 편집 “Service” 부분에 “edgelambda.amazonaws.com” 를 추가합니다.<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">        <span class="attr">"Service"</span>: [</span><br><span class="line">          <span class="string">"edgelambda.amazonaws.com"</span>,</span><br><span class="line">          <span class="string">"lambda.amazonaws.com"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"Action"</span>: <span class="string">"sts:AssumeRole"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<h4 id="5-Lambda-함수-생성"><a href="#5-Lambda-함수-생성" class="headerlink" title="5) Lambda 함수 생성"></a>5) Lambda 함수 생성</h4><ol>
<li><p><a href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions" target="_blank" rel="noopener">Lambda 함수 콘솔</a>에 접속합니다.</p>
</li>
<li><p><code>버지니아 리전</code>을 선택 후, ‘Create function’ 클릭</p>
</li>
<li><p>기본 정보 설정</p>
<ul>
<li>함수 이름: ResizeImage</li>
<li>Runtime: Node.js 10.x</li>
<li>권한<ul>
<li>실행 역할: 기존 역할 사용</li>
<li>기존 역할: ResizeImage - <a href="#4-IAM-역할-생성">4) IAM 역할 생성</a></li>
</ul>
</li>
</ul>
</li>
<li><p>다음 페이지의 기본 설정 후, ‘Save’ 클릭</p>
<ul>
<li>메모리: 함수를 실행하는 환경의 메모리 용량을 <code>128MB</code>로 설정</li>
<li>제한 시간: 함수의 실행 제한 시간을 <code>5초</code>로 설정</li>
</ul>
<div class="alert warning"><p>Lambda@edge 에 배포 하려면 반드시 버지니아 리전에 생성해야 합니다. </p>
</div>

<div class="alert info"><p><a href="https://aws.amazon.com/ko/lambda/pricing/#Lambda.40Edge_Pricing_Details" target="_blank" rel="noopener">Lambda@edge 요금</a> 페이지에 요금 계산기가 있습니다.</p>
</div>

<h5 id="Lambda-vs-Lambda-edge"><a href="#Lambda-vs-Lambda-edge" class="headerlink" title="Lambda vs Lambda@edge"></a>Lambda vs Lambda@edge</h5><div class="figure center" style="width:90%;"><a class="fancybox" href="compare_lambda.png" title data-caption data-fancybox="default"><img class="fig-img" src="compare_lambda.png" style="width:90%;" alt></a></div><div style="clear:both;"></div>
</li>
</ol>
<ul>
<li>language: Lambda 와 다르게 Node.js 만 지원함.</li>
<li>Memory: Lambda@edge 메모리 수정 불가하며 128M 고정. 함수 최적화 필수.</li>
<li>Execution time: <a href="#Lambda-edge-기본-동작-원리">Lambda@edge 기본 동작 원리</a>에 request, response 간에 시간도 소요되므로 최소 4초 이상 걸림.</li>
<li>Deployment size: 함수의 라이브러리 포함하여 압축 용량이 극히 1MB 로 제한적</li>
<li>Request pricing: 100만건당 기준 비용</li>
<li>Duration granularity: 비용 측정하는 시간 단위</li>
<li>128MB for 100ms: Lambda@edge 가 50ms 실행 했을 때, 비용은 $0.0000003125 입니다.</li>
</ul>
<h4 id="6-Cloud9-을-이용한-Lambda-함수-작성"><a href="#6-Cloud9-을-이용한-Lambda-함수-작성" class="headerlink" title="6) Cloud9 을 이용한 Lambda 함수 작성"></a>6) Cloud9 을 이용한 Lambda 함수 작성</h4><ul>
<li><p><a href="https://aws.amazon.com/ko/cloud9/" target="_blank" rel="noopener">AWS Cloud9</a>은 코드 작성, 실행 및 디버깅을 위한 클라우드 기반 IDE입니다.</p>
<div class="alert warning"><p>글쓰는 시점의 Cloud9 은 서울 리전을 지원하지 않습니다.</p>
</div>

<div class="alert info"><p><a href="https://aws.amazon.com/ko/cloud9/pricing/" target="_blank" rel="noopener">Cloud9 요금</a></p>
</div>
</li>
</ul>
<ol>
<li><p><a href="https://us-east-1.console.aws.amazon.com/cloud9/home?region=us-east-1" target="_blank" rel="noopener">Cloud9 콘솔</a>에 접속하고 우측의 ‘Create environment’ 클릭</p>
</li>
<li><p>다음 이미지의 설정을 따릅니다.</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="cloud9_1.png" title="cloud9 생성 1단계" data-caption="cloud9 생성 1단계" data-fancybox="default"><img class="fig-img" src="cloud9_1.png" style="width:90%;" alt="cloud9 생성 1단계"></a><span class="caption">cloud9 생성 1단계</span></div><div style="clear:both;"></div>

<div class="figure center" style="width:90%;"><a class="fancybox" href="cloud9_2.png" title="cloud9 생성 2단계" data-caption="cloud9 생성 2단계" data-fancybox="default"><img class="fig-img" src="cloud9_2.png" style="width:90%;" alt="cloud9 생성 2단계"></a><span class="caption">cloud9 생성 2단계</span></div><div style="clear:both;"></div>
</li>
<li><p><code>ResizeImage</code> Lambda 함수를 Cloud9 으로 가져 옵니다. (이미지 번호 순서 확인)</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="cloud9_code_1.png" title data-caption data-fancybox="default"><img class="fig-img" src="cloud9_code_1.png" style="width:90%;" alt></a></div><div style="clear:both;"></div>
</li>
<li><p>패키지 설치</p>
<ul>
<li>이미지 리사이징 <a href="https://www.npmjs.com/package/sharp" target="_blank" rel="noopener">Sharp</a> 패키지를 설치 합니다.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ec2-user:~/environment $ <span class="built_in">cd</span> ResizeImage</span><br><span class="line">ec2-user:~/environment/ResizeImage $ npm init -y</span><br><span class="line">...</span><br><span class="line">ec2-user:~/environment/ResizeImage $ npm install sharp</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>함수 작성</p>
<ul>
<li><p>Gist 에 있는 <a href="https://gist.github.com/devhaks/8c558f118036e0b6b13ce329d9b77c47" target="_blank" rel="noopener">코드</a>를 코드 작성 영역에 복붙하고 Code Line 14 <code>BUCKET</code> 을 수정합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> BUCKET = <span class="string">'devhaks-sample-s3'</span> <span class="comment">// Input your bucket</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>코드 설명</p>
<ol>
<li><p>다음과 같이 QueryString 으로 이미지 리사이징 할 정보를 추가하여 요청합니다. </p>
<ul>
<li><a href="https://dilgv5hokpawv.cloudfront.net/dev/thumbnail.png?w=200&amp;h=150&amp;f=webp&amp;q=90" target="_blank" rel="noopener">https://dilgv5hokpawv.cloudfront.net/dev/thumbnail.png?w=200&amp;h=150&amp;f=webp&amp;q=90</a></li>
</ul>
</li>
<li><p>Lambda 함수는 요청 주소를 ObjectKey 와 QueryString 을 파싱합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; uri &#125; = request;</span><br><span class="line"><span class="keyword">const</span> ObjectKey = <span class="built_in">decodeURIComponent</span>(uri).substring(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> params = querystring.parse(request.querystring);</span><br><span class="line"><span class="keyword">const</span> &#123; w, h, q, f &#125; = params</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parsing result</span></span><br><span class="line"><span class="comment"> * - ObjectKey: 'dev/thumbnail.png'</span></span><br><span class="line"><span class="comment"> * - w: '200'</span></span><br><span class="line"><span class="comment"> * - h: '150'</span></span><br><span class="line"><span class="comment"> * - f: 'webp'</span></span><br><span class="line"><span class="comment"> * - q: '90'</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>S3 로 부터 ObjectKey 와 일치하는 이미지 리소스를 가져옵니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  s3Object = <span class="keyword">await</span> S3.getObject(&#123;</span><br><span class="line">    Bucket: BUCKET,</span><br><span class="line">    Key: ObjectKey</span><br><span class="line">  &#125;).promise();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> callback(<span class="literal">null</span>, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>이미지를 리사이징 합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  resizedImage = <span class="keyword">await</span> Sharp(s3Object.Body)</span><br><span class="line">    .resize(width, height)</span><br><span class="line">    .toFormat(format, &#123;</span><br><span class="line">      quality</span><br><span class="line">    &#125;)</span><br><span class="line">    .toBuffer();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> callback(<span class="literal">null</span>, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Response 객체의 정보를 수정하고 함수를 종료합니다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">responseHandler(</span><br><span class="line">  <span class="number">200</span>,</span><br><span class="line">  <span class="string">'OK'</span>,</span><br><span class="line">  resizedImage.toString(<span class="string">'base64'</span>), [&#123;</span><br><span class="line">    key: <span class="string">'Content-Type'</span>,</span><br><span class="line">    value: <span class="string">`image/<span class="subst">$&#123;format&#125;</span>`</span></span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="string">'base64'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @summary response 객체 수정을 위한 wrapping 함수</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">responseHandler</span>(<span class="params">status, statusDescription, body, contentHeader, bodyEncoding</span>) </span>&#123;</span><br><span class="line">  response.status = status;</span><br><span class="line">  response.statusDescription = statusDescription;</span><br><span class="line">  response.body = body;</span><br><span class="line">  response.headers[<span class="string">'content-type'</span>] = contentHeader;</span><br><span class="line">  <span class="keyword">if</span> (bodyEncoding) &#123;</span><br><span class="line">    response.bodyEncoding = bodyEncoding;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Success resizing image'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> callback(<span class="literal">null</span>, response);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Lambda 함수 업데이트</p>
</li>
</ol>
<div class="figure center" style="width:70%;"><a class="fancybox" href="cloud9_code_2.png" title data-caption data-fancybox="default"><img class="fig-img" src="cloud9_code_2.png" style="width:70%;" alt></a></div><div style="clear:both;"></div>


</li>
</ul>
</li>
</ol>
<h4 id="7-Lambda-edge-함수에-Lambda-함수-배포"><a href="#7-Lambda-edge-함수에-Lambda-함수-배포" class="headerlink" title="7) Lambda@edge 함수에 Lambda 함수 배포"></a>7) Lambda@edge 함수에 Lambda 함수 배포</h4><ol>
<li><p><a href="https://console.aws.amazon.com/lambda/home?region=us-east-1#/functions" target="_blank" rel="noopener">Lambda 함수 콘솔</a>에 재접속하여 <code>ResizeImage</code> 함수 정보로 이동합니다.</p>
</li>
<li><p>상단 메뉴에 작업 &gt; <code>Lambda@edge 배포</code>를 클릭하고 아래 이미지 처럼 설정을 따릅니다.</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="lambda_edge_deploy.png" title data-caption data-fancybox="default"><img class="fig-img" src="lambda_edge_deploy.png" style="width:90%;" alt></a></div><div style="clear:both;"></div>

<ul>
<li><p>캐시 동작: production 배포 전, 먼저 <code>dev/*</code>에서 테스트를 진행 합니다.</p>
</li>
<li><p>CloudFront 이벤트: <code>오리진 응답(Origin response)</code>을 선택합니다. 왜냐하면 origin 에서 리소스 존재 여부를 판단 후 존재하면, 함수를 실행시켜야 하기 때문입니다.</p>
</li>
<li><p>배포 완료된 상태</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="lambda_edge_deploy_2.png" title data-caption data-fancybox="default"><img class="fig-img" src="lambda_edge_deploy_2.png" style="width:90%;" alt></a></div><div style="clear:both;"></div>

</li>
</ul>
<div class="alert warning"><p>Lambda@edge 함수에 배포 후, 적용까지 약 3~5분 정도 소요됩니다.</p>
</div>

</li>
</ol>
<h4 id="8-이미지-리사이징-요청하기"><a href="#8-이미지-리사이징-요청하기" class="headerlink" title="8) 이미지 리사이징 요청하기"></a>8) 이미지 리사이징 요청하기</h4><ul>
<li><p>요청할 이미지 주소: <a href="https://dilgv5hokpawv.cloudfront.net/dev/thumbnail.png?w=200&amp;h=150&amp;f=webp&amp;q=90" target="_blank" rel="noopener">https://dilgv5hokpawv.cloudfront.net/dev/thumbnail.png?w=200&amp;h=150&amp;f=webp&amp;q=90</a></p>
</li>
<li><p>리사이징된 이미지 결과 확인</p>
<ul>
<li><p>결과를 확인하면 이미지의 800x800 -&gt; 200x150 으로 변경된 이미지를 확인 할 수 있습니다.</p>
</li>
<li><p>개발자 도구를 열어서 이미지 리소스의 response header 를 확인</p>
<ul>
<li>content-type: image/webp</li>
<li>최초 이미지 요청시<br>  x-cache: Miss from cloudfront</li>
<li>다음 이미지 요청시,<br>  x-cache: Hit from cloudfront</li>
</ul>
</li>
</ul>
</li>
<li><p>CloudWatch Log 확인</p>
<p><a href="https://ap-northeast-2.console.aws.amazon.com/cloudwatch/" target="_blank" rel="noopener">CloudWatch 콘솔</a>에 접속하여 좌측 ‘로그’ 페이지로 이동합니다. </p>
  <div class="figure fig-50" style="width:;"><a class="fancybox" href="cloudwatch_1.png" title data-caption data-fancybox="cloudwatch"><img class="fig-img" src="cloudwatch_1.png" alt></a></div>

  <div class="figure fig-50" style="width:;"><a class="fancybox" href="cloudwatch_2.png" title data-caption data-fancybox="cloudwatch"><img class="fig-img" src="cloudwatch_2.png" alt></a></div><div style="clear:both;"></div>

  <div class="figure center" style="width:;"><a class="fancybox" href="cloudwatch_3.png" title data-caption data-fancybox="default"><img class="fig-img" src="cloudwatch_3.png" alt></a></div><div style="clear:both;"></div>

<div class="alert info"><p>위 로그 그룹이 보이지 않는다면, 서울 리전을 확인하세요.   </p>
</div>
</li>
<li><p>이미지 생성이 안될 경우</p>
<ul>
<li><p>이 문제는 Lambda@edge 가 배포 되기 전에 이미 한번 요청한 주소의 리소스가 캐시된 경우 발생합니다. 그래서 캐싱된 리소스를 <code>invalidation(무효화)</code>를 해야합니다.<br><code>/dev/*</code> 경로는 <code>/dev</code> 뒤에 붙는 리소스를 가리킵니다. (/ = root path)</p>
<div class="figure center" style="width:;"><a class="fancybox" href="cloudfront_invalidation.png" title data-caption data-fancybox="default"><img class="fig-img" src="cloudfront_invalidation.png" alt></a></div><div style="clear:both;"></div>

</li>
</ul>
<div class="alert info"><p>CloudFront caching 방식의 기준은 주소 또는 헤더 설정에 따라 다릅니다. 여기서 주소 방식은 QueryString 순서만 변경되어도 다른 리소스로 인식됩니다.<br>ex 1) ?w=200&amp;h=150&amp;f=webp&amp;q=90<br>ex 2) ?h=150&amp;w=200&amp;f=webp&amp;q=90<br>두 이미지의 결과는 동일 하지만, caching은 1번이 아닌 2번이 발생합니다. 심각한 문제는 아니지만. 이미지 리사이징 할때, 똑같은 결과물이 2번 생성하지 않도록 주의 합시다.</p>
</div>


</li>
</ul>
<h4 id="9-production-에-배포하기"><a href="#9-production-에-배포하기" class="headerlink" title="9) production 에 배포하기"></a>9) production 에 배포하기</h4><ul>
<li><p><a href="#7-Lambda-edge-함수에-Lambda-함수-배포">7) Lambda@edge 함수에 Lambda 함수 배포</a> 과정의 첫번째 이미지에서 캐시 동작을 <code>dev/*</code> 로 지정 했었습니다. 이미지 리사이징이 성공했다면, <code>트리거 추가</code>버튼을 클릭하여 캐시 동작을 <code>prod/*</code>로 선택하고 나머지 옵션은 동일하게 하여 추가합니다. 아래 이미지 처럼 2개의 CloudFront 이벤트 트리거가 등록된 것을 확인할 수 있습니다.</p>
<div class="figure center" style="width:90%;"><a class="fancybox" href="lambda_edge_deploy_3.png" title data-caption data-fancybox="default"><img class="fig-img" src="lambda_edge_deploy_3.png" style="width:90%;" alt></a></div><div style="clear:both;"></div>

</li>
</ul>
<br>

<h2 id="CloudFront-와-CORS-Cross-Origin-Resource-Sharing"><a href="#CloudFront-와-CORS-Cross-Origin-Resource-Sharing" class="headerlink" title="CloudFront 와 CORS(Cross-Origin Resource Sharing)"></a>CloudFront 와 CORS(Cross-Origin Resource Sharing)</h2><p>  위 예제에서는 브라우저 주소창에 이미지 주소를 바로 요청했기 때문에 <a href="https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/dev/cors.html" target="_blank" rel="noopener">CORS</a>에 제약을 받는 상황은 없었습니다. 왜냐하면, 브라우저 주소가 이미지 주소의 origin 과 동일한 same origin 이기 때문이빈다. </p>
<p>  브라우저 기본 기능에는 <code>&lt;img/&gt;, &lt;script/&gt;, &lt;link/&gt;</code> 태그를 사용하여 리소스를 얻을 수 있습니다. </p>
<p>  그러나 XHR (XMLHttpRequest) 로 리소스를 요청 할 경우, CORS 제약을 받아서 리소스를 얻을 수 없습니다. 이러한 경우, 리소스를 보유한 Origin 에서 CORS 정책을 설정하여 해결 해야합니다.<br>  <br></p>
<ol>
<li><p>CORS 제약을 받는 상황을 만들기 위해 S3(Origin)에 다음과 같이 pdf 파일을 업로드합니다.</p>
<p>— devhaks-sample-s3<br>&nbsp;&nbsp;&nbsp;|— <a href="./devhaks-github-io.pdf" target="_blank">devhaks-github-io.pdf</a>&nbsp;&nbsp;(&lt;= 파일 다운로드)</p>
</li>
<li><p>브라우저 pdf viewer 로 pdf 를 불러오면, 아래 이미지처럼 에러가 발생합니다.</p>
<ul>
<li><p>아래 ‘your_cloudfront_domain’ 부분을 주소에 맞게 바꿔주세요.</p>
</li>
<li><p><a href="https://mozilla.github.io/pdf.js/web/viewer.html?file=https://your_cloudfront_domain/devhaks-github-io.pdf" target="_blank" rel="noopener">https://mozilla.github.io/pdf.js/web/viewer.html?file=https://your_cloudfront_domain/devhaks-github-io.pdf</a></p>
</li>
</ul>
<div class="figure center" style="width:;"><a class="fancybox" href="pdf_cors.png" title data-caption data-fancybox="default"><img class="fig-img" src="pdf_cors.png" alt></a></div><div style="clear:both;"></div>

<ul>
<li>요청지: <a href="https://mozilla.github.io" target="_blank" rel="noopener">https://mozilla.github.io</a></li>
<li>Origin: <a href="https://your_cloudfront_domain" target="_blank" rel="noopener">https://your_cloudfront_domain</a></li>
<li>pdf viewer 는 pdf 의 주소로 XHR 요청을 보내는데 요청지와 Origin 이 서로 다르기 때문에 위와 같은 에러가 발생한 것입니다.</li>
</ul>
</li>
<li><p>이를 해결하기 위해 <a href="https://s3.console.aws.amazon.com/s3/" target="_blank" rel="noopener">S3 콘솔</a> -&gt; 버킷 -&gt; 권한 -&gt; CORS 구성으로 이동하여 다음을 복붙하고 저장합니다. 그리고 다시 pdf viewer 를 새로고침 해보면, 정상적으로 pdf 파일이 출력 될 것입니다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CORSConfiguration</span> <span class="attr">xmlns</span>=<span class="string">"http://s3.amazonaws.com/doc/2006-03-01/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CORSRule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AllowedOrigin</span>&gt;</span>https://mozilla.github.io<span class="tag">&lt;/<span class="name">AllowedOrigin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AllowedMethod</span>&gt;</span>GET<span class="tag">&lt;/<span class="name">AllowedMethod</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">CORSRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">CORSConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="마치며"><a href="#마치며" class="headerlink" title="마치며"></a>마치며</h2><p>이번 글을 정리하면서 익숙하지 않았거나 궁금했던 AWS 서비스의 요소들을 자세히 학습하게되서 뿌듯하고 실력이 향상되는 느낌이 많이 들었습니다. 지금은 개발 중인 서비스에 적용한 것에 그치지만 개인 프로젝트를 진행 할 때, 꼭 적용 해봐야 겠습니다. </p>
<h2 id="참고글"><a href="#참고글" class="headerlink" title="참고글"></a>참고글</h2><ul>
<li><p>당근마켓 블로그 <a href="https://medium.com/daangn/lambda-edge%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-on-the-fly-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95-f4e5052d49f3" target="_blank" rel="noopener">AWS Lambda@Edge에서 실시간 이미지 리사이즈 &amp; WebP 형식으로 변환</a></p>
</li>
<li><p>heropy tech <a href="https://heropy.blog/2019/07/21/resizing-images-cloudfrount-lambda/" target="_blank" rel="noopener">AWS Lambda@edge로 실시간 이미지 리사이징</a></p>
</li>
<li><p>AWS <a href="https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-examples.html" target="_blank" rel="noopener">Lambda@Edge 함수 예제</a></p>
</li>
</ul>
<h2 id="연관글"><a href="#연관글" class="headerlink" title="연관글"></a>연관글</h2><ul>
<li><a href="https://www.theteams.kr/teams/385/post/64311" target="_blank" rel="noopener">AWS Lambda에서 메모리 설정값과 CPU 파워의 관계</a></li>
</ul>

            

        </div>
    </div>

    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/CloudFront/">CloudFront</a> <a class="tag tag--primary tag--small t-link" href="/tags/Lambda-edge/">Lambda@edge</a> <a class="tag tag--primary tag--small t-link" href="/tags/aws/">aws</a> <a class="tag tag--primary tag--small t-link" href="/tags/cloud9/">cloud9</a> <a class="tag tag--primary tag--small t-link" href="/tags/image-resize/">image resize</a> <a class="tag tag--primary tag--small t-link" href="/tags/s3/">s3</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <!-- <a class="post-action-btn btn btn--disabled">
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span> -->
                
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/06/30/docker-1/" data-tooltip="Docker 초급 (1)" aria-label="NEXT: Docker 초급 (1)">
                        <span class="text-small icon-mr">Docker 초급 (1)</span>
                        <!-- <span class="hide-xs hide-sm text-small icon-mr">Docker 초급 (1)</span> -->
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <!-- <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li> -->
        
            
            
            <li class="post-action">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#disqus_thread">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <!-- <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top"> -->
            
                <!-- <i class="fa fa-list" aria-hidden="true"></i> -->
            <!-- </a> -->
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://devhaks.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
            
        
    </div>
</article>


                
<footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 이종학. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-bar-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <!-- <a class="post-action-btn btn btn--disabled">
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span> -->
                
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/06/30/docker-1/" data-tooltip="Docker 초급 (1)" aria-label="NEXT: Docker 초급 (1)">
                        <span class="hide-xs hide-sm text-small icon-mr">Docker 초급 (1)</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#disqus_thread">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/">
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/">
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/dfca80a65a05d05bf0d417a6ca99a57d?s=110" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">이종학</h4>
        
            <!-- <div id="about-card-bio"><p>author.bio</p>
</div> -->
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Software developer</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-gqfkjfdb6bghizjmdhv1eect2ihkmgoyo6be4xlkou3yljsi2ml5hdwn5chn.min.js"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'https://devhaks.github.io/2019/08/25/aws-lambda-image-resizing/';
                 
                    this.page.identifier = '2019/08/25/aws-lambda-image-resizing/';
                 
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'devhaks';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    




        <script src="https://unpkg.com/vanilla-back-to-top@7.2.0/dist/vanilla-back-to-top.min.js"></script>
        <script>
            addBackToTop({
                cornerOffset: 70,
                scrollDuration : 250,
                diameter: 56,
                backgroundColor: 'rgb(255, 82, 82)',
                textColor: '#fff'
            })
        </script> 
    </body>
</html>
